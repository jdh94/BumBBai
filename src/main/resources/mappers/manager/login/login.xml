<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MANAGER_LOGIN">
    <resultMap type="HashMap" id="clobMap">
        <result property="USE_STPLAT_CN" column="USE_STPLAT_CN" jdbcType="CLOB" javaType="java.lang.String" />
    </resultMap>
    
    <select id="GET_LOGIN" resultType="Map" parameterType="Map">
        /* LOGIN */
		SELECT ID
     	, WORKER_ID
     	, NAME
     	, DEPARMENT
     	, TEL
     	, LOGIN_FAIL_COUNT
     	, ACCOUNT_STATUS
     	, REG_DATE
     	, GRADE
     	, CASE WHEN ( ( select config_value from system_configuration where code = '24' ) - login_fail_count  <![CDATA[<=]]> 0  )THEN 'Y' else 'N' END AS LOGIN_FAIL_COUNT_OVER_YN
     	,     CASE WHEN ( PASSWORD_UPDATE_DATE - sysdate <![CDATA[<=]]> 0 ) THEN 'Y' ELSE 'N' END AS PASSWORD_EXPIRE_YN
  	FROM SYSTEM_USER SU        
   WHERE SU.ID = #{login_id}
	 <if test="login_pw != 'Y'.toString()"> 
		AND SU.PASSWORD = #{login_pw}
	 </if>
    </select>
    
    <update id="UPDATE_FAIL_CNT" parameterType="map">
		/* 로그인 실패 업데이트 */
		UPDATE SYSTEM_USER SET LOGIN_FAIL_COUNT = (LOGIN_FAIL_COUNT + 1) WHERE ID = #{login_id}
	</update>
    <update id="UPDATE_USER_STATUS" parameterType="map">
		/* 사용자 상태 업데이트 */
		UPDATE SYSTEM_USER SET ACCOUNT_STATUS = #{account_status} WHERE ID = #{login_id}
	</update>
    <update id="SET_USER_LOGINFAILCOUNT" parameterType="map">
		/* 로그인 실패 카운트 리셋 */
		UPDATE SYSTEM_USER SET LOGIN_FAIL_COUNT = 0 WHERE ID = #{login_id}
	</update>

   <select id="GET_LOGIN_FAIL_CNT" resultType="Map" parameterType="Map">
        /* LOGIN */
		SELECT ID
		     , LOGIN_FAIL_COUNT
		     , ( select config_value from system_configuration where code = '24' ) AS LOGIN_FAIL_CONFIG_COUNT
		     , ( CASE WHEN ( ( select config_value from system_configuration where code = '24' ) - login_fail_count  <![CDATA[<=]]> 0  ) THEN 'Y' else 'N' END ) AS LOGIN_FAIL_COUNT_OVER_YN 
		  FROM SYSTEM_USER SU
		 WHERE SU.ID = #{login_id}
    </select>


   	<!-- 삭제대상 -->
    <select id="GET_MANAGER_IP" resultType="Map" parameterType="Map">
        /* 사용자 접근 가능 IP 조회 */
		SELECT MILT.ACCESS_IP AS IP FROM MCST_IP_ACC_LIMIT_INFO_TBL MILT WHERE MILT.USER_ID = #{login_id}
    </select>
    
    <select id="GET_RE_AGREE_INFO_LIST" parameterType="map" resultMap="clobMap">
        /* 로그인 재동의 리스트 조회 */
        SELECT USE_STPLAT_ID,
		USE_STPLAT_NM,
		USE_STPLAT_CN
		FROM COMTNSTPLATINFO
    </select>    
    	
	
	<insert id="INSERT_LOGIN_LOG" parameterType="map">
		/* 사용자 접근 로그 입력 */
			INSERT INTO USER_LOGIN_HISTORY
				( ID
				  , LOGIN_ID
				  , ACCESS_IP
				  , ACCESS_DATE
				  , SU_ID
				  , ACCESS_INFO)
			VALUES ( cliv_seq.nextval
					,#{login_id}
					,#{login_ip}
					,sysdate
					,null
					,#{access_info})
	</insert>
	
    <select id="GET_LOGIN_USER_LAST_AGENT_PATH" resultType="string" parameterType="Map">
        /* 중복 로그인 확인 */
		SELECT AGENT_PATH
		FROM
		  (SELECT AGENT_PATH
		  FROM COMTNLOGINLOG
		  WHERE CONECT_ID = #{login_id}
		  AND CONECT_MTHD = 'I'
		  ORDER BY CREAT_DT DESC
		  )
		WHERE ROWNUM = 1
    </select>
</mapper>